/**
 * Set the image options or select an image to insert.
 *
 * @author Arjan Scherpenisse <arjan@scherpenisse.net>
 * @author Moxiecode
 * @copyright 2010-2012 Arjan Scherpenisse <arjan@scherpenisse.net>
 * @copyright Copyright 2004-2008, Moxiecode Systems AB, All rights reserved.
 */tinymce.PluginManager.requireLangPack("zmedia"),function(){"use strict";window.tinyMCEzMedia={toHTML:function(e,t){var n,r;return n="z-tinymce-media z-tinymce-media-align-"+(t.align||"block"),r='<img class="'+n+'" '+'data-zmedia-id="'+e+'" '+'data-zmedia-opts="'+JSON.stringify(t).replace(/\"/g,"&quot;")+'" '+' src="/admin/media/preview/'+e+'" />',r}},tinymce.create("tinymce.plugins.ZotonicMediaPlugin",{init:function(e,t){var n=this,r,i,s={align:"block",size:"middle",crop:"",link:""};r=e.getParam("z_properties_dialog_enabled",!0),i=e.getParam("z_insert_dialog_enabled",!0),e.on("setContent",function(t){if(r){var n=$(e.getContainer()).find("iframe");n.contents().find("img.z-tinymce-media").addClass("z-active")}}),e.addCommand("mceZotonicMedia",function(t){var o=t||e.selection.getNode();o&&n._domIsZMedia(o)?r&&n._openPropertiesDialog(o):i&&n._openInsertDialog(e,s)}),e.on("click",function(t){t.srcElement.nodeName==="IMG"&&e.execCommand("mceZotonicMedia",t.srcElement)}),e.on("postProcess",function(e){e.content=n._MediaHtmlToMarkers(e.content)}),e.on("loadContent",function(t){e.setContent(n._zMarkersToMediaHtml(t.content))}),e.on("beforeSetContent",function(e){e.content=n._zMarkersToMediaHtml(e.content)}),e.addButton("zmedia",{icon:"image",title:"Insert a Zotonic media item",cmd:"mceZotonicMedia","class":"mce_image"}),e.addMenuItem("zmedia",{icon:"image",text:"Insert Zotonic media item",context:"format",cmd:"mceZotonicMedia","class":"mce_image"})},getInfo:function(){return{longname:"Zotonic Media Plugin",author:"Arjan Scherpenisse",authorurl:"http://www.zotonic.com",infourl:"http://www.zotonic.com",version:tinymce.majorVersion+"."+tinymce.minorVersion}},_openPropertiesDialog:function(e){var t=this._zMediaIdFromDOM(e),n=this._zMediaOptsFromDOM(e);z_dialog_open({title:"Media properties",text:'<form id="zmedia-props-form" class="form">  <div class="form-group row">      <div class="col-md-6">          <img style="width: 100%" src="/admin/media/preview/'+t+'" class="z-tinymce-media-left" />'+"      </div>"+'      <div class="col-md-3">'+'                  <div class="form-group">'+'                      <label class="control-label">Alignment</label>'+'                      <div class="controls">'+'                          <div class="radio"><label><input type="radio" name="align" '+(n.align==="block"?'checked="checked"':"")+' value="block" id="a-block"> Between text</label></div>'+'                          <div class="radio"><label><input type="radio" name="align" '+(n.align==="left"?'checked="checked"':"")+'value="left" id="a-left"> Aligned left</label></div>'+'                          <div class="radio"><label><input type="radio" name="align" '+(n.align==="right"?'checked="checked"':"")+'value="right" id="a-right"> Aligned right</label></div>'+"                      </div>"+"                  </div>"+'                  <div class="form-group">'+'                      <label class="control-label">Crop</label>'+'                      <div class="controls">'+'                          <div class="checkbox"><label><input type="checkbox" name="crop" '+(n.crop==="crop"?'checked="checked"':"")+' value="crop" id="a-crop"> Crop image</label></div>'+"                      </div>"+"                  </div>"+"              </div>"+'              <div class="col-md-3">'+'                  <div class="form-group">'+'                      <label class="control-label">Size</label>'+'                      <div class="controls">'+'                          <div class="radio"><label><input type="radio" name="size" '+(n.size==="small"?'checked="checked"':"")+' value="small" id="a-small"> Small</label></div>'+'                          <div class="radio"><label><input type="radio" name="size" '+(n.size==="middle"||n.size===undefined?'checked="checked"':"")+'value="middle" id="a-middle"> Middle</label></div>'+'                          <div class="radio"><label><input type="radio" name="size" '+(n.size==="large"?'checked="checked"':"")+'value="large" id="a-large"> Large</label></div>'+"                      </div>"+"                  </div>"+'                  <div class="form-group">'+'                      <label class="control-label">Link</label>'+'                      <div class="controls">'+'                          <div class="checkbox"><label><input type="checkbox" name="link" '+(n.link==="link"?'checked="checked"':"")+' value="crop" id="a-link"> Make link</label></div>'+"                      </div>"+"                  </div>"+"              </div>"+"          </div>"+'          <div class="row">'+'              <div class="col-md-3">'+"              </div>"+'              <div class="col-md-3">'+"              </div>"+"          </div>"+"      </div>"+"  </div>"+'  <div class="modal-footer">'+'      <button class="btn" id="zmedia-props-cancel">Cancel</button>'+'      <button class="btn btn-primary" type="submit">Save Properties</button>'+"  </div>"+"</form>"}),$("#zmedia-props-form").submit(function(){var n,r={align:$("#zmedia-props-form input[name='align']:checked").val(),size:$("#zmedia-props-form input[name='size']:checked").val(),crop:$("#zmedia-props-form input[name='crop']:checked").val()?"crop":"",link:$("#zmedia-props-form input[name='link']:checked").val()?"link":""};return n=$(window.tinyMCEzMedia.toHTML(t,r)),e.className=n.attr("class"),$(e).attr("data-zmedia-opts",n.attr("data-zmedia-opts")).attr("data-zmedia-id",n.attr("data-zmedia-id")),z_dialog_close(),!1}),$("#zmedia-props-cancel").click(function(){return z_dialog_close(),!1})},_openInsertDialog:function(e,t){window.z_choose_zmedia=function(n){var r;if(!n)return;r=window.tinyMCEzMedia.toHTML(n,t),e.execCommand("mceInsertContent",!1,r,{})},z_event("zmedia",{language:window.zEditLanguage(),is_zmedia:1})},_domIsZMedia:function(e){return this._zMediaIdFromDOM(e)!==null},_zMediaIdFromDOM:function(e){return e.getAttribute("data-zmedia-id")},_zMediaOptsFromDOM:function(e){return JSON.parse(e.getAttribute("data-zmedia-opts"))},_zMediaClass:function(){return"z-tinymce-media"},_MediaHtmlToMarkers:function(e){var t=new RegExp("<img.*?/>","g"),n,r,i,s,o,u,a;for(;;){n=t.exec(e);if(n===null)break;r=n[0],i=(new RegExp('data-zmedia-id="([0-9]+)',"g")).exec(r);if(!i)return e;s=i[1],o=(new RegExp('data-zmedia-opts="(\\{.*?\\})"',"g")).exec(r);if(!o)return e;u=JSON.parse(o[1].replace(/&quot;/g,'"')),a=this._zMediaMarker(s,u),e=e.substr(0,t.lastIndex-r.length)+a+e.substr(t.lastIndex),t.lastIndex=t.lastIndex-r.length+a.length}return e},_zMediaMarker:function(e,t){return"<!-- z-media "+e+" "+JSON.stringify(t)+" -->"},_zMarkersToMediaHtml:function(e){var t=new RegExp("<!-- z-media (.*?) (.*?)-->","g"),n,r,i,s;for(;;){n=t.exec(e);if(n===null)break;r=n[1],i=JSON.parse(n[2]),s=window.tinyMCEzMedia.toHTML(r,i),e=e.substr(0,t.lastIndex-n[0].length)+s+e.substr(t.lastIndex),t.lastIndex=t.lastIndex-n[0].length+s.length}return e}}),tinymce.PluginManager.add("zmedia",tinymce.plugins.ZotonicMediaPlugin)}();